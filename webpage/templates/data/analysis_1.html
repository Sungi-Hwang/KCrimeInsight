{% extends 'base.html' %}

{% block title_block %}
<title>유흥업소-폭력범죄 상관계수 분석</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content_block %}

<div class="breadcrumbs">
  <div class="col-sm-4">
    <div class="page-header float-left">
      <div class="page-title">
        <h1>유흥업소-폭력범죄 상관분석</h1>
      </div>
    </div>
  </div>
  <div class="col-sm-8">
    <div class="page-header float-right">
      <div class="page-title">
        <ol class="breadcrumb text-right">
          <li><a href="{{url_for('main.index')}}">Main Page</a></li>
          <li><a href="#">분석</a></li>
          <li class="active">상관계수 분석</li>
        </ol>
      </div>
    </div>
  </div>
</div>
<form method="POST">
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label for="ent_type">업종 선택:</label>
    <select name="ent_type" id="ent_type">
      <option value="전체" {% if selected_type == '전체' %}selected{% endif %}>전체</option>
      {% for t in ent_types %}
        {% if t != '전체' %}
          <option value="{{ t }}" {% if selected_type == t %}selected{% endif %}>{{ t }}</option>
        {% endif %}
      {% endfor %}
    </select>
  
    <label for="mode">분석 기준:</label>
    <select name="mode" id="mode">
      <option value="절대값" {% if selected_mode == '절대값' %}selected{% endif %}>절대값 기준</option>
      <option value="비율" {% if selected_mode == '비율' %}selected{% endif %}>인구 대비 비율</option>
    </select>
  
    <button type="submit">분석</button>
  </form>
  <br>

<div class="content mt-3">
  <div class="animated fadeIn">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <strong class="card-title">지역별 유흥업소 수 & 폭력범죄 건수</strong>
          </div>
          <div class="card-body">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>지역</th>
                  <th>유흥업소 수</th>
                  <th>폭력범죄 건수</th>
                </tr>
              </thead>
              <tbody>
                {% for row in merged_data %}
                <tr>
                  <td>{{ row['지역'] }}</td>
                  <td>{{ row['엔터수'] }}</td>
                  <td>{{ row['폭력범죄건수'] }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <hr>
            <h3 style="margin-top:10px; margin-bottom:10px;">
              현재 <strong>{{ selected_type }}</strong> 와(과) 
              <strong>
              {% if selected_mode == '절대값' %}
                절대값 기준
              {% else %}
                인구대비 비율 기준
              {% endif %}
              </strong>
              폭력범죄 상관분석 결과
            </h3>

            <h5 style="margin-bottom:10px;">상관계수 결과</h5>
            <p>Pearson 상관계수: {{ pearson_corr }} 
              <span style="color: {{ 'red' if pearson_p < 0.05 else 'gray' }}">
                  (p-value: {{ pearson_p }})
              </span>
            </p>
            <p>Spearman 상관계수: {{ spearman_corr }} 
                <span style="color: {{ 'red' if spearman_p < 0.05 else 'gray' }}">
                    (p-value: {{ spearman_p }})
                </span>
            </p>

            <hr>
            <h5>산점도 그래프</h5>
            <canvas id="scatterChart" width="800" height="400"></canvas>

            <script>
              const ctx = document.getElementById('scatterChart').getContext('2d');
              const isRatio = "{{ selected_mode }}" === "비율";

              const scatterOptions = {
                scales: {
                  x: {
                    type: 'linear',
                    position: 'bottom',
                    min: 0,
                    max: isRatio ? {{ max_x }} : undefined,
                    title: { display: true, text: isRatio ? '업소수 비율' : '업소 수' }
                  },
                  y: {
                    min: 0,
                    max: isRatio ? {{ max_y }} : undefined,
                    title: { display: true, text: isRatio ? '폭력범죄 비율' : '폭력범죄 건수' }
                  }
                }
              };

              const scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                  datasets: [
                    {
                      label: '상관 산점도',
                      data: {{ scatter_data|tojson }},
                      backgroundColor: 'rgba(75, 192, 192, 1)'
                    },
                    {
                      label: '회귀선',
                      type: 'line',
                      data: {{ regression_line|tojson }},
                      borderColor: 'rgba(255, 99, 132, 1)',
                      fill: false
                    }
                  ]
                },
                options: scatterOptions
              });

              // 온오프 함수
              function toggleTrendline() {
                const meta = scatterChart.getDatasetMeta(1);
                meta.hidden = !meta.hidden;
                scatterChart.update();
              }

            </script>
         </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
